<?xml version="1.0" encoding="utf-8" ?>

<!-- Various code modifications to improve trade hub throughput; more details please see README. -->

<diff>
    <!-- Start with something easy: divert some traders to directly consider imports -->
    <add sel="/aiscript[@name='trade.find.commander']/attention/actions/label[@name='sell']" pos="after">
        <do_if value="not @$hasDivertedImporting" chance="20" comment="Small chance to divert to handle imports">
            <!-- Jump to ware imports -->
            <set_value name="$hasDivertedImporting" exact="true" />
            <resume label="buy" />
        </do_if>
    </add>
    <add sel="/aiscript[@name='trade.find.commander']/attention/actions/run_script" pos="before">
        <!-- Interestingly, there is only 1 run_script tag in the entire script... -->
        <!-- This is before the "long sleep" after "failed to trade: no trade found" -->
        <do_if value="@$hasDivertedImporting">
            <!-- Actually, we did not try exporting. Let's get back to there! -->
            <resume label="start" />
        </do_if>
    </add>

    <add sel="/aiscript[@name='trade.find.commander']/attention/actions/do_while/set_value[@name='$loopcount']" pos="after">
        <do_if value="this.ship.idcode == 'CDC-081'">
            <show_help custom="'CDC-081 idling.'" pos="1" duration="3s" chance="100" />
        </do_if>
        <do_if value="$commanderstation.tradewares.list.count gt 0" comment="It seems istradestation is only for the specified NPC tradestations">
            <show_help custom="'Commander is tradestation; high-volume trading!'" pos="1" duration="3s" chance="0" />
            <set_value name="$loopcount" exact="$loopcount + 2" comment="this results in 3x the speed; new idle time range is 0.5 to 1.83 minutes" />
        </do_if>
    </add>

    <!-- Case study: a certain L trader coded as "CDC-081" -->
    <add sel="//interrupts/library/actions">
        <do_if value="this.ship.idcode == 'CDC-081'">
            <show_help custom="'CDC-081 FindCommanderStation'" pos="1" duration="3s" chance="100" />
        </do_if>
    </add>
    <add sel="//label[@name='start']" pos="after">
        <do_if value="this.ship.idcode == 'CDC-081'">
            <show_help custom="'CDC-081 entering \'start\' state.'" pos="1" duration="3s" chance="100" />
        </do_if>
    </add>
    <add sel="//label[@name='sell']" pos="after">
        <do_if value="this.ship.idcode == 'CDC-081'">
            <show_help custom="'CDC-081 trying to sell something for commander.'" pos="1" duration="3s" chance="100" />
        </do_if>
    </add>
    <add sel="//label[@name='buy']" pos="after">
        <do_if value="this.ship.idcode == 'CDC-081'">
            <show_help custom="'CDC-081 trying to buy something for commander.'" pos="1" duration="3s" chance="100" />
        </do_if>
    </add>
    <add sel="//label[@name='finish']" pos="after">
        <do_if value="this.ship.idcode == 'CDC-081'">
            <show_help custom="'CDC-081 entering \'finish\' state; buyoffer ' + $buyoffer + ' selloffer ' + $selloffer + ' failurereason ' + @$failurereason" pos="1" duration="3s" chance="100" />
            <show_help custom="'SELLOFFER INFO:\n\'%1 %2\' sells %3 units of %4 for a total price of %5 Cr. Price per unit: %6'.[$selloffer.seller.knownname, $selloffer.seller, $selloffer.offeramount.{this.ship}, $selloffer.ware.name, $selloffer.price/1Cr, $selloffer.unitprice]" pos="1" duration="6s" chance="100" />
            <show_help custom="'BUYOFFER INFO:\n\'%1 %2\' buys %3 (desires: %6) units of %4 for a total price of %5 Cr. Price per unit: %7'.[$buyoffer.buyer.knownname, $buyoffer.buyer, $buyoffer.offeramount.{this.ship}, $buyoffer.ware.name, $buyoffer.price/1Cr, $buyoffer.offeramount.{this.assignedcontrolled}, $buyoffer.unitprice]" pos="1" duration="6s" chance="100" />
        </do_if>
    </add>
</diff>
